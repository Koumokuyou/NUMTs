#!/bin/sh
# Author: Muyao HUANG 2024
argNum=2
if [ "$#" -ne 2 ]; then
    echo "You need $argNum arguments" 1>&2
    echo "input_maf_file" 1>&2
    echo "reverse_maf" 1>&2
    echo "Usage: $0 <input_maf_file> <reverse_maf>" 1>&2
    exit 1
fi

input_maf=$1
reverse_maf=$2

# Find the maximum score in reverse file
temp=$(awk '
     /^a/{
        split($2, arr, "=")
        score = arr[2] + 0
        print score
    }
' "$reverse_maf")

# If temp is empty, output the original input and exit
if [ -z "$temp" ]; then
    cat "$input_maf"
    exit 0
fi

# Loop through each score in the $temp and compare with the minimum value
max_score=$(echo "$temp" | head -n 1)
while read -r score; do
    if (( $(echo "$score > $max_score" | bc -l) )); then
        max_score=$score
    fi
done <<< "$temp"
echo "max score in reverse test: $max_score"

filtered_concent=$(grep -v '^#' $input_maf)
awk -v score_threshold=$max_score -v OFS="\n" -v ORS="\n\n" '
    BEGIN {
        RS="\n\n"; FS="\n"
    }
    {   
        split($1, a, " ")
        split(a[2], arr, "=")
        score = arr[2] + 0 
        if (score > score_threshold) {
            print $0
        }
    }' <<< "$filtered_concent"
